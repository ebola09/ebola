<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ebola arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
    <link rel="stylesheet" href="../css/themes.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <script src="../js/themes.js"></script>
    <script>
        // Load partials first
        async function loadPartials() {
            try {
                const [topbar, bottombar, settings] = await Promise.all([
                    fetch('../partials/topbar.html').then(res => res.text()),
                    fetch('../partials/bottombar.html').then(res => res.text()),
                    fetch('../partials/settings.html').then(res => res.text())
                ]);
                document.getElementById('topbar-placeholder').innerHTML = topbar;
                document.getElementById('bottombar-placeholder').innerHTML = bottombar;
                document.getElementById('settingsPanel').innerHTML = settings;
                // Now initialize the app
                initApp();
            } catch (err) {
                console.error('Error loading partials:', err);
            }
        }

        loadPartials();
    </script>
</head>

<script>
        // The sequence we want to detect
        const sequence = ['t', 'r', 'e', 'e'];
        let currentIndex = 0;

        // Listen for key presses
        document.addEventListener('keydown', (event) => {
            // Check if the key matches the current position in the sequence
            if (event.key.toLowerCase() === sequence[currentIndex]) {
                currentIndex++;
                // If we've completed the sequence, redirect
                if (currentIndex === sequence.length) {
                    window.location.href = 'tree.html';
                }
            } else {
                // Reset if the key doesn't match
                currentIndex = 0;
            }
        });
    </script>
<body>
    

    <div id="topbar-placeholder"></div>

    <div class="main-content">
        <div class="ad-sidebar">
            <div id="adContainer" class="ad-scroll">
                <!-- New games will be populated here -->
            </div>
        </div>
        <div class="games-container">
            <div class="grid-section">
                <h2 class="grid-title">recently played</h2>
                <div id="recentlyPlayedGrid"></div>
            </div>

            <div class="grid-section">
                <div class="grid-title-container">
                    <h2 class="grid-title">all games</h2>
                    <input type="text" class="search-input" id="gameSearch" placeholder="search">
                </div>
                <div id="gameGrid"></div>
            </div>
        </div>
    </div>

    <div id="bottombar-placeholder"></div>

    <div id="settingsPanel"></div>

    <script>
        function initApp() {
        const MAX_RECENT = 5;
        const recentlyPlayedGrid = document.getElementById("recentlyPlayedGrid");
        const gameGrid = document.getElementById("gameGrid");
        const settingsButton = document.getElementById("settingsButton");
        const settingsPanel = document.querySelector('.settings-panel');
        const themeSelect = document.getElementById("themeSelect");
        const importButton = document.getElementById("importProgress");
        const importFile = document.getElementById("importFile");

        // Set active link in topbar based on current URL
        const leftLinks = document.querySelectorAll('.topbar .left a');
        leftLinks.forEach(link => link.classList.remove('active'));
        if (window.location.pathname.includes('/arcade/')) {
            leftLinks[0].classList.add('active');
        } else if (window.location.pathname.includes('/tv/')) {
            leftLinks[1].classList.add('active');
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            return parts.length === 2 ? parts.pop().split(';').shift() : null;
        }
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + days*24*60*60*1000);
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = `${name}=${value}${expires}; path=/`;
        }

        function getRecentlyPlayed() {
            const cookie = getCookie("recentlyPlayed");
            if (!cookie) return [];
            try { return JSON.parse(cookie); } catch { return []; }
        }

        function saveRecentlyPlayed(games) {
            setCookie("recentlyPlayed", JSON.stringify(games), 30);
        }

        function updateRecentlyPlayedUI(games) {
            recentlyPlayedGrid.innerHTML = "";
            if (!games.length) {
                recentlyPlayedGrid.innerHTML = "<p style='color: var(--link-color);'>you haven't played any games yet :(</p>";
                return;
            }
            games.forEach(game => {
                const card = document.createElement("a");
                card.href = game.path || "#";
                card.className = "card";
                card.style.backgroundImage = `url('${game.thumbnail || ""}')`;
                card.setAttribute("data-title", game.name || "Untitled");
                recentlyPlayedGrid.appendChild(card);
            });
        }

        function addRecentlyPlayed(game) {
            const recent = getRecentlyPlayed().filter(g => g.name !== game.name);
            recent.unshift(game);
            if (recent.length > MAX_RECENT) recent.pop();
            saveRecentlyPlayed(recent);
            updateRecentlyPlayedUI(recent);
        }

        function getFavorites() {
            const cookie = getCookie("favorites");
            if (!cookie) return [];
            try { return JSON.parse(cookie); } catch { return []; }
        }

        function saveFavorites(games) {
            setCookie("favorites", JSON.stringify(games), 30);
        }

        function isFavorited(game) {
            return getFavorites().some(f => f.name === game.name);
        }

        function toggleFavorite(game) {
            let favs = getFavorites();
            if (isFavorited(game)) {
                favs = favs.filter(f => f.name !== game.name);
            } else {
                favs.push(game);
            }
            saveFavorites(favs);
            // Re-display current view
            const query = gameSearch.value.toLowerCase();
            let gamesToDisplay = allGames;
            if (query) {
                gamesToDisplay = allGames.filter(g => {
                    const nameMatch = (g.name || "").toLowerCase().includes(query);
                    const tagMatch = g.tags && g.tags.some(tag => tag.toLowerCase().includes(query));
                    return nameMatch || tagMatch;
                });
            }
            displayGames(sortGames(gamesToDisplay));
        }

        function sortGames(games) {
            return games.sort((a, b) => {
                const aFav = isFavorited(a);
                const bFav = isFavorited(b);
                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;
                return (a.name || "").toLowerCase().localeCompare((b.name || "").toLowerCase());
            });
        }

        document.addEventListener("DOMContentLoaded", () => updateRecentlyPlayedUI(getRecentlyPlayed()));

        if (!localStorage.getItem("gameProgress")) localStorage.setItem("gameProgress", "{}");

        document.getElementById("exportProgress").addEventListener("click", () => {
            const allStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allStorage[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(allStorage, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "localStorage_backup.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importButton.addEventListener("click", () => importFile.click());
        importFile.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    localStorage.setItem("gameProgress", JSON.stringify(JSON.parse(reader.result)));
                    alert("Game progress imported successfully!");
                } catch {
                    alert("Invalid JSON file. Please select a valid game progress file.");
                }
            };
            reader.readAsText(file);
            e.target.value = "";
        });

        function setTheme(theme) {
    const c = colors[theme];

    const root = document.documentElement;
    root.style.setProperty('--bg-color', c.bg);
    root.style.setProperty('--text-color', c.text);
    root.style.setProperty('--link-color', c.link);
    root.style.setProperty('--link-hover-color', c.hover);
    root.style.setProperty('--card-border-color', c.border);
    root.style.setProperty('--card-overlay-color', c.overlay);
    root.style.setProperty('--bottombar-border-color', c.bottomBorder);
    root.style.setProperty('--bottombar-opacity', c.opacity);

    document.querySelectorAll('.tos-button').forEach(btn => {
        btn.style.backgroundColor = c.bg;
        btn.style.color = c.text;
        btn.style.borderColor = c.border;
    });

    const svg = document.querySelector('.topbar .logo svg');
    if (svg) svg.querySelectorAll('path').forEach(path => path.setAttribute('fill', c.svgColor));

    setCookie("theme", theme, 30);
}


        const savedTheme = getCookie("theme");
        if (savedTheme) {
            setTheme(savedTheme);
            themeSelect.value = savedTheme;
        } else {
            setCookie("theme", "orange", 30);
            setTheme("orange");
            themeSelect.value = "orange";
        }

        settingsButton.addEventListener("click", () => {
            const isOpen = settingsPanel.style.display === "block";
            settingsPanel.style.display = isOpen ? "none" : "block";
            settingsButton.classList.toggle('settings-open', !isOpen);
        });

        themeSelect.addEventListener("change", () => setTheme(themeSelect.value));

        let allGames = [];

        function displayGames(games) {
            gameGrid.innerHTML = "";
            games.forEach(game => {
                const card = document.createElement("a");
                card.href = game.path || "#";
                card.className = "card";
                if (isFavorited(game)) card.classList.add("favorited");
                card.style.backgroundImage = `url('${game.thumbnail || ""}')`;
                card.setAttribute("data-title", game.name || "Untitled");
                card.addEventListener("click", () => addRecentlyPlayed(game));
                // Favorite badge
                const favoriteBadge = document.createElement("div");
                favoriteBadge.className = "favorite-badge";
                favoriteBadge.textContent = isFavorited(game) ? "★" : "☆";
                favoriteBadge.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleFavorite(game);
                });
                card.appendChild(favoriteBadge);
                if (game.tags && game.tags.includes("new")) {
                    const newBadge = document.createElement("div");
                    newBadge.className = "new-badge";
                    newBadge.textContent = "new";
                    card.appendChild(newBadge);
                }
                gameGrid.appendChild(card);
            });
        }

        fetch("gameList.json")
            .then(res => res.json())
            .then(data => {
                if (!data.games?.length) {
                    gameGrid.innerHTML = `<p style="color: var(--link-color);">No games found. Check gameList.json.</p>`;
                    return;
                }
                data.games.sort((a,b) => (a.name||"").toLowerCase().localeCompare((b.name||"").toLowerCase()));
                allGames = sortGames(data.games);
                const newGames = data.games.filter(g => g.tags && g.tags.includes("new"));
                const adContainer = document.getElementById("adContainer");
                if (newGames.length > 0) {
                    newGames.forEach(game => {
                        const adItem = document.createElement("a");
                        adItem.href = game.path || "#";
                        adItem.className = "ad-item";
                        adItem.style.backgroundImage = `url('${game.thumbnail || ""}')`;
                        adItem.setAttribute("data-title", game.name || "Untitled");
                        adItem.addEventListener("click", () => addRecentlyPlayed(game));
                        adContainer.appendChild(adItem);
                    });
                    // duplicate for seamless scroll
                    newGames.forEach(game => {
                        const adItem = document.createElement("a");
                        adItem.href = game.path || "#";
                        adItem.className = "ad-item";
                        adItem.style.backgroundImage = `url('${game.thumbnail || ""}')`;
                        adItem.setAttribute("data-title", game.name || "Untitled");
                        adItem.addEventListener("click", () => addRecentlyPlayed(game));
                        adContainer.appendChild(adItem);
                    });
                } else {
                    adContainer.innerHTML = "<p style='color: var(--link-color); font-size: 14px;'>No new games</p>";
                }
                displayGames(allGames);
            })
            .catch(err => {
                gameGrid.innerHTML = `<p style="color: var(--link-color);">Failed to load gameList.json</p>`;
                console.error("Error loading game list:", err);
            });

        const gameSearch = document.getElementById("gameSearch");
        gameSearch.addEventListener("input", () => {
            const query = gameSearch.value.toLowerCase();
            const filteredGames = allGames.filter(game => {
                const nameMatch = (game.name || "").toLowerCase().includes(query);
                const tagMatch = game.tags && game.tags.some(tag => tag.toLowerCase().includes(query));
                return nameMatch || tagMatch;
            });
            displayGames(sortGames(filteredGames));
        });

        }
    </script>
</body>
</html>



