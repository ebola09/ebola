<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
    <base href="https://cdn.jsdelivr.net/gh/gn-math/assets@main/286/">
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width, user-scalable=no' />
    <title>Endoparasitic</title>

    <link rel="stylesheet" href="style.css">
    <link rel='icon' type='image/png' href='Endoparasitic.icon.png' />
    <link rel='apple-touch-icon' href='Endoparasitic.apple-touch-icon.png'/>

    <!-- Safari detection + flags -->
    <script>
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        if (isSafari) {
            window.GODOT_FORCE_WEBGL1 = true;
            window.GODOT_DISABLE_AA = true;
        }
    </script>
</head>

<body>
    <script src="main.js"></script>

    <div id="loading-text"
         style="color:white;font-family:cursive;font-size:48px;text-align:center;margin-top:20px;">
        LOADING...
    </div>

    <canvas id="canvas">
        HTML5 canvas appears to be unsupported in the current browser.
    </canvas>

    <div id="status">
        <div id="status-progress" style="display:none" oncontextmenu="event.preventDefault();">
            <div id="status-progress-inner"></div>
        </div>

        <div id="status-indeterminate" style="display:none" oncontextmenu="event.preventDefault();">
            <div></div><div></div><div></div><div></div>
            <div></div><div></div><div></div><div></div>
        </div>

        <div id="status-notice" class="godot" style="display:none;"></div>
    </div>

    <script src="Endoparasitic.js"></script>

    <script>
        const GODOT_CONFIG = {
            args: [],
            canvasResizePolicy: 2,
            executable: "Endoparasitic",
            experimentalVK: false,
            fileSizes: {
                "Endoparasitic.pck": 129276352,
                "Endoparasitic.wasm": 17867504
            },
            focusCanvas: true,
            gdnativeLibs: [],
            useWebGL2: false,
            antialias: false
        };

        const engine = new Engine(GODOT_CONFIG);

        let triedReload = false;

        function startGodotSafely() {
            try {
                window.godotrunfunction();
            } catch (e) {
                console.error(e);

                if (!triedReload) {
                    triedReload = true;
                    location.reload();
                } else {
                    document.body.innerHTML =
                        "<h2 style='color:white;text-align:center;margin-top:20vh'>" +
                        "Safari failed to initialize WebGL.<br>" +
                        "Please reload or use Chrome / Firefox." +
                        "</h2>";
                }
            }
        }

        window.godotrunfunction = function () {
            const statusProgress = document.getElementById('status-progress');
            const statusProgressInner = document.getElementById('status-progress-inner');
            const statusIndeterminate = document.getElementById('status-indeterminate');
            const statusNotice = document.getElementById('status-notice');

            document.getElementById("loading-text")?.remove();

            function setStatus(mode) {
                statusProgress.style.display = "none";
                statusIndeterminate.style.display = "none";
                statusNotice.style.display = "none";

                if (mode === "progress") statusProgress.style.display = "block";
                if (mode === "indeterminate") statusIndeterminate.style.display = "block";
                if (mode === "notice") statusNotice.style.display = "block";
            }

            function fail(err) {
                console.error(err);
                statusNotice.textContent = err.message || err;
                setStatus("notice");
            }

            if (!Engine.isWebGLAvailable()) {
                fail("WebGL not available");
                return;
            }

            setStatus("indeterminate");

            engine.startGame({
                onProgress(current, total) {
                    if (total > 0) {
                        statusProgressInner.style.width = (current / total * 100) + "%";
                        setStatus("progress");
                    }
                }
            }).then(
                () => setStatus("hidden"),
                fail
            );
        };

        // Safari timing fix: delay startup
        window.addEventListener("load", () => {
            setTimeout(startGodotSafely, 300);
        });
    </script>
</body>
</html>
