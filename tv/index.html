<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ebola tv</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
    <link rel="stylesheet" href="../css/themes.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <script src="../js/themes.js"></script>

    <script>
        async function loadPartials() {
            try {
                const [topbar, bottombar, settings] = await Promise.all([
                    fetch('../partials/topbar.html').then(res => res.text()),
                    fetch('../partials/bottombar.html').then(res => res.text()),
                    fetch('../partials/settings.html').then(res => res.text())
                ]);
                document.getElementById('topbar-placeholder').innerHTML = topbar;
                document.getElementById('bottombar-placeholder').innerHTML = bottombar;
                document.getElementById('settingsPanel').innerHTML = settings;
                initApp();
            } catch (err) {
                console.error('Error loading partials:', err);
                
            }
        }

        loadPartials();
    </script>
</head>

<body>

<div id="topbar-placeholder"></div>

<div class="main-content">
    <div class="games-container">
        <div class="grid-section" id="gridSection">
            <div class="grid-title-container">
                <h2 class="grid-title">top results</h2>
                    <input type="text" class="search-input" id="tvSearch" placeholder="search">
            </div>
            <div id="tvGrid"></div>
        </div>

        <div class="grid-section" id="singleShowSection" style="display: none;">
            <h2 id="showTitle"></h2>
            <canvas id="showCanvas" width="800" height="600"></canvas>
        </div>
        </div>
    </div>
</div>

<div id="bottombar-placeholder"></div>
<div id="settingsPanel"></div>

<script>
function initApp() {
    const tvGrid = document.getElementById('tvGrid');
    const recentlyPlayedGrid = document.getElementById('recentlyPlayedGrid');
    const tvSearch = document.getElementById('tvSearch');
    const gridSection = document.getElementById('gridSection');
    const singleShowSection = document.getElementById('singleShowSection');
    const showTitle = document.getElementById('showTitle');
    const showCanvas = document.getElementById('showCanvas');

    /* ðŸ”’ API calls now go through Vercel */
    async function fetchTV(endpoint) {
        const res = await fetch(`/api/tmdb?endpoint=${endpoint}`);
        const data = await res.json();
        return data.results || data;
    }

    function displayTVShows(shows, gridElement) {
        gridElement.innerHTML = '';
        if (!shows || shows.length === 0) {
            gridElement.innerHTML = '<p style="color: var(--text-color);">nothing to see here...</p>';
            return;
        }
        shows.forEach(show => {
            if (!show.poster_path) return;
            const card = document.createElement('div');
            card.className = 'tv-card';
            card.style.backgroundImage = `url('https://image.tmdb.org/t/p/w500${show.poster_path}')`;
            card.innerHTML = `
                <div class="tv-title">${show.name}</div>
                <div class="tv-rating">â˜… ${show.vote_average.toFixed(1)}</div>
            `;
            card.addEventListener('click', async () => {
                const external = await fetchTV(`tv/${show.id}/external_ids`);
                const imdb_id = external.imdb_id;
                if (imdb_id) {
                    window.location.href = `/tv/${imdb_id}`;
                }
            });
            gridElement.appendChild(card);
        });
    }

    function displaySingleShow(show) {
        showTitle.textContent = show.name;
        gridSection.style.display = 'none';
        singleShowSection.style.display = 'block';
        // Canvas is empty as requested
    }

    /* Theme & Settings */
    const settingsButton = document.getElementById("settingsButton");
    const settingsPanel = document.querySelector('.settings-panel');
    const themeSelect = document.getElementById("themeSelect");

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : null;
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + days * 86400000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = `${name}=${value}${expires}; path=/`;
    }

    function setTheme(theme) {
        const c = colors[theme];
        const root = document.documentElement;
        Object.entries({
            '--bg-color': c.bg,
            '--text-color': c.text,
            '--link-color': c.link,
            '--link-hover-color': c.hover,
            '--card-border-color': c.border,
            '--card-overlay-color': c.overlay,
            '--bottombar-border-color': c.bottomBorder,
            '--bottombar-opacity': c.opacity
        }).forEach(([k, v]) => root.style.setProperty(k, v));

        setCookie("theme", theme, 30);
    }

    const savedTheme = getCookie("theme") || "orange";
    setTheme(savedTheme);
    themeSelect.value = savedTheme;

    settingsButton.addEventListener("click", () => {
        settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block";
    });

    themeSelect.addEventListener("change", () => setTheme(themeSelect.value));

    /* Highlight topbar link */
    const leftLinks = document.querySelectorAll('.topbar .left a');
    leftLinks.forEach(link => link.classList.remove('active'));
    if (window.location.pathname.includes('/arcade/')) leftLinks[0].classList.add('active');
    else if (window.location.pathname.includes('/tv/')) leftLinks[1].classList.add('active');

    /* Check if URL has show ID */
    const pathParts = window.location.pathname.split('/');
    const showId = pathParts[pathParts.length - 1];
    if (showId && showId !== 'tv' && showId !== '') {
        (async () => {
            let show;
            if (showId.startsWith('tt')) {
                // IMDb ID
                const findData = await fetchTV(`find/${showId}?external_source=imdb_id`);
                show = findData.tv_results && findData.tv_results[0];
            } else {
                // Assume TMDB ID
                show = await fetchTV(`tv/${showId}`);
            }
            if (show) {
                displaySingleShow(show);
            }
        })();
    } else {
        /* =======================
           Load trending instantly
           ======================= */
        let trendingCache = [];

        (async () => {
            trendingCache = await fetchTV('trending/tv/week');
            displayTVShows(trendingCache, tvGrid);

            // Optionally, load recently played or popular shows
            if (recentlyPlayedGrid) {
                const popular = await fetchTV('tv/popular');
                displayTVShows(popular, recentlyPlayedGrid);
            }
        })();

        /* =======================
           Search handler
           ======================= */
        tvSearch.addEventListener('input', async () => {
            const query = tvSearch.value.trim();
            if (query) {
                const results = await fetchTV(`search/tv&query=${encodeURIComponent(query)}`);
                displayTVShows(results, tvGrid);
            } else {
                // Show cached trending if search is empty
                displayTVShows(trendingCache, tvGrid);
            }
        });
    }
}
</script>


</body>
</html>