<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ebola tv</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
    <link rel="stylesheet" href="../css/themes.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <script src="../js/themes.js"></script>

    <script>
        async function loadPartials() {
            try {
                const [topbar, bottombar, settings] = await Promise.all([
                    fetch('../partials/topbar.html').then(res => res.text()),
                    fetch('../partials/bottombar.html').then(res => res.text()),
                    fetch('../partials/settings.html').then(res => res.text())
                ]);
                document.getElementById('topbar-placeholder').innerHTML = topbar;
                document.getElementById('bottombar-placeholder').innerHTML = bottombar;
                document.getElementById('settingsPanel').innerHTML = settings;
                initApp();
            } catch (err) {
                console.error('Error loading partials:', err);
            }
        }

        loadPartials();
    </script>
</head>

<body>

<div id="topbar-placeholder"></div>

<div class="main-content">
    <div class="games-container">
        <div class="grid-section">
            <div class="grid-title-container">
                <h2 class="grid-title">top results</h2>
                <input type="text" class="search-input" id="tvSearch" placeholder="search">
            </div>
            <div id="tvGrid"></div>
        </div>

        <div class="grid-section" id="recentlyPlayedGridContainer">
            <div id="recentlyPlayedGrid"></div>
        </div>
    </div>
</div>

<div id="bottombar-placeholder"></div>
<div id="settingsPanel"></div>

<script>
function initApp() {
    const tvGrid = document.getElementById('tvGrid');
    const tvSearch = document.getElementById('tvSearch');
    const recentlyPlayedGrid = document.getElementById('recentlyPlayedGrid');

    /* ðŸ”’ API calls through Vercel */
    async function fetchTV(endpoint) {
        const res = await fetch(`/api/tmdb?endpoint=${endpoint}`);
        const data = await res.json();
        return data.results;
    }

    async function fetchMovieByImdb(imdbID) {
        try {
            const res = await fetch(`/api/tmdb?endpoint=find/${imdbID}&external_source=imdb_id`);
            const data = await res.json();
            if (data.movie_results && data.movie_results.length > 0) {
                return data.movie_results[0].title;
            } else {
                return "Movie not found";
            }
        } catch (err) {
            console.error(err);
            return "Error fetching movie";
        }
    }

    function displayTVShows(shows, gridElement) {
        gridElement.innerHTML = '';
        if (!shows || shows.length === 0) {
            gridElement.innerHTML = '<p style="color: var(--text-color);">nothing to see here...</p>';
            return;
        }
        shows.forEach(show => {
            if (!show.poster_path) return;
            const card = document.createElement('div');
            card.className = 'tv-card';
            card.style.backgroundImage = `url('https://image.tmdb.org/t/p/w500${show.poster_path}')`;
            card.innerHTML = `
                <div class="tv-title">${show.name}</div>
                <div class="tv-rating">â˜… ${show.vote_average.toFixed(1)}</div>
            `;
            gridElement.appendChild(card);
        });
    }

    /* ==============================
       URL Parsing for IMDb page
       ============================== */
    const path = window.location.pathname;
    const parts = path.split('/').filter(Boolean); // ["tv", "tt0816692"] or ["tv"]
    const imdbID = parts[1] || null;

    if (imdbID) {
        // Hide search and grid
        if (tvGrid) tvGrid.style.display = 'none';
        if (tvSearch) tvSearch.style.display = 'none';
        if (recentlyPlayedGrid) recentlyPlayedGrid.parentElement.style.display = 'none';

        // Display movie title
        fetchMovieByImdb(imdbID).then(title => {
            const mainContent = document.querySelector('.main-content');
            const titleElement = document.createElement('h1');
            titleElement.textContent = title;
            titleElement.style.margin = '20px 0';
            titleElement.style.color = 'var(--text-color)';
            mainContent.prepend(titleElement);
        });
    }

    /* ==============================
       Theme & Settings
       ============================== */
    const settingsButton = document.getElementById("settingsButton");
    const settingsPanel = document.querySelector('.settings-panel');
    const themeSelect = document.getElementById("themeSelect");

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : null;
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + days * 86400000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = `${name}=${value}${expires}; path=/`;
    }

    function setTheme(theme) {
        const c = colors[theme];
        const root = document.documentElement;
        Object.entries({
            '--bg-color': c.bg,
            '--text-color': c.text,
            '--link-color': c.link,
            '--link-hover-color': c.hover,
            '--card-border-color': c.border,
            '--card-overlay-color': c.overlay,
            '--bottombar-border-color': c.bottomBorder,
            '--bottombar-opacity': c.opacity
        }).forEach(([k, v]) => root.style.setProperty(k, v));

        setCookie("theme", theme, 30);
    }

    const savedTheme = getCookie("theme") || "orange";
    setTheme(savedTheme);
    themeSelect.value = savedTheme;

    if (settingsButton) {
        settingsButton.addEventListener("click", () => {
            settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block";
        });
    }

    if (themeSelect) {
        themeSelect.addEventListener("change", () => setTheme(themeSelect.value));
    }

    /* ==============================
       Highlight topbar link
       ============================== */
    const leftLinks = document.querySelectorAll('.topbar .left a');
    leftLinks.forEach(link => link.classList.remove('active'));
    if (window.location.pathname.includes('/arcade/')) leftLinks[0]?.classList.add('active');
    else if (window.location.pathname.includes('/tv/')) leftLinks[1]?.classList.add('active');

    /* ==============================
       Load trending / recently played
       ============================== */
    if (!imdbID) {
        let trendingCache = [];
        (async () => {
            trendingCache = await fetchTV('trending/tv/week');
            displayTVShows(trendingCache, tvGrid);

            if (recentlyPlayedGrid) {
                const popular = await fetchTV('tv/popular');
                displayTVShows(popular, recentlyPlayedGrid);
            }
        })();

        /* ==============================
           Search handler
           ============================== */
        tvSearch.addEventListener('input', async () => {
            const query = tvSearch.value.trim();
            if (query) {
                const results = await fetchTV(`search/tv&query=${encodeURIComponent(query)}`);
                displayTVShows(results, tvGrid);
            } else {
                displayTVShows(trendingCache, tvGrid);
            }
        });
    }
}
</script>

</body>
</html>
